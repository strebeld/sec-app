<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mongo Todo</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-xl mx-auto py-10 px-4">
    <h1 class="text-3xl font-bold mb-6">âœ… Mongo Todo</h1>

    <form id="new-form" class="flex gap-2 mb-6">
      <input id="new-title" class="flex-1 rounded-xl border px-3 py-2" placeholder="What needs doing?" required />
      <button class="rounded-xl bg-blue-600 text-white px-4 py-2">Add</button>
    </form>

    <ul id="list" class="space-y-2"></ul>
  </div>

  <template id="item-tpl">
    <li class="bg-white rounded-xl shadow p-3 flex items-center gap-3">
      <input type="checkbox" class="h-5 w-5" />
      <input class="flex-1 outline-none" />
      <button class="text-red-600 hover:underline">Delete</button>
    </li>
  </template>

  <script>
    const API = '/api/todos';
    const list = document.getElementById('list');
    const form = document.getElementById('new-form');
    const titleInput = document.getElementById('new-title');

    async function fetchJSON(url, options) {
      const res = await fetch(url, { headers: { 'Content-Type': 'application/json' }, ...options });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    async function load() {
      list.innerHTML = '';
      const items = await fetchJSON(API);
      for (const todo of items) addRow(todo);
    }

    function addRow(todo) {
      const tpl = document.getElementById('item-tpl').content.cloneNode(true);
      const li = tpl.querySelector('li');
      const cb = tpl.querySelector('input[type="checkbox"]');
      const text = tpl.querySelector('input[type="text"], input:not([type])');
      const del = tpl.querySelector('button');

      cb.checked = todo.completed;
      text.value = todo.title;

      cb.addEventListener('change', async () => {
        const updated = await fetchJSON(`${API}/${todo._id}`, {
          method: 'PATCH',
          body: JSON.stringify({ completed: cb.checked })
        });
        todo.completed = updated.completed;
      });

      text.addEventListener('change', async () => {
        const updated = await fetchJSON(`${API}/${todo._id}`, {
          method: 'PATCH',
          body: JSON.stringify({ title: text.value })
        });
        todo.title = updated.title;
      });

      del.addEventListener('click', async () => {
        await fetchJSON(`${API}/${todo._id}`, { method: 'DELETE' });
        li.remove();
      });

      list.appendChild(li);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = titleInput.value.trim();
      if (!title) return;
      const created = await fetchJSON(API, { method: 'POST', body: JSON.stringify({ title }) });
      addRow(created);
      titleInput.value = '';
    });

    load().catch(err => console.error(err));
  </script>
</body>
</html>